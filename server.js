const net = require('net');
const { addColor, print } = require('./colors.js');
const {
    encryptPub,
    decryptPub,
    genRandomBytes,
} = require('./encrypt.js');
const {
    concatData,
    send
} = require('./dataProcess.js');

const getServerEncrypt = (pubKey) => {
    const encrypt = (data) => {
        return encryptPub(pubKey, data)
    };
    return encrypt;
};

const getServerDecrypt = (pubKey) => {
    const decrypt = (data) => {
        return decryptPub(pubKey, data)
    };
    return decrypt;
};

const getServer = (pubKey) => {
    const encrypt = getServerEncrypt(pubKey);
    const decrypt = getServerDecrypt(pubKey);

    const server = net.createServer((c) => {
        let dataReceivedMap = new Map();

        c.on('end', () => {
            console.log(`Client disconnected, ip: ${c.remoteAddress}`);
        });
        c.on('data', (d) => {
            print('\n--------\n');
            print(`Received encrypted data from ${c.remoteAddress}\n`, 'green');
            print('Encrypted: ', 'yellow');
            print(`${d.toString('hex')}\n`);

            const decryptedJSON = decrypt(d);
            const decryptedData = JSON.parse(decryptedJSON);

            print('Message Type: ', 'yellow');
            print(`${decryptedData.type}\n`);

            print('Message length: ', 'yellow');
            print(`${decryptedJSON.length}\n`);

            print('Data length: ', 'yellow');
            print(`${decryptedData.data.length}\n`);

            print(`Segment: ${decryptedData.seg_no} of ${decryptedData.seg_num}\n`, 'red');
            print('--------\n\n');

            dataReceivedMap.set(decryptedData.seg_no, decryptedData.data);
            if(decryptedData.seg_no === decryptedData.seg_num) {
                const concatedData = concatData(dataReceivedMap);
                dataReceivedMap = new Map();

                print('\n--------\n');
                print('Decrypted: ', 'yellow');
                print(`${concatedData}\n`);
                print('--------\n\n');

                const dataReply = `Server has received the data with length ${concatedData.length} - ${addColor(Date().toString(), 'green')}`;
                send(c, encrypt, dataReply);
            }
        });

        // Say hi to client!
        const randomBytes = genRandomBytes(64).toString('hex');
        print(`Client connected, from ${c.remoteAddress}\n`);
        print(`Random string: `, 'green');
        print(`${randomBytes}\n`);
         
        const dataBack = `Hello from server! - ${addColor(Date().toString(), 'green')}`;
        send(c, encrypt, dataBack);
        const randomInfo = `Random string generated by server: ${randomBytes}`;
        send(c, encrypt, randomInfo);
    });
    return server;
};

module.exports = {
    getServer
};