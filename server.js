const net = require('net');
const { addColor, print, printSys } = require('./colors.js');
const {
    encryptPub,
    decryptPub,
    genRandomBytes,
} = require('./encrypt.js');
const {
    send,
    MAX_BLK_NUM
} = require('./dataProcess.js');

const getServerEncrypt = (pubKey) => {
    const encrypt = (data) => {
        return encryptPub(pubKey, data)
    };
    return encrypt;
};

const getServerDecrypt = (pubKey) => {
    const decrypt = (data) => {
        return decryptPub(pubKey, data)
    };
    return decrypt;
};

const processDataServer = (head, chunks, decrypt) => {
    print('\n--------\n');
    print(`Received All Data of req_id `);
    print(`${head.req_id}\n`, 'red');
    print(`Received Data is of Type `);
    print(`${head.type}\n`, 'red');

    const chunkSize = chunks.size;

    const decryptedData = [];
    for(let i = 1; i <= chunkSize; i++) {
        const dataSlice = chunks.get(i);
        decryptedData.push(decrypt(dataSlice));
    }

    // console.log(decryptedData);
    let decryptedDataStr = '';
    for(let each of decryptedData) {
        decryptedDataStr += each.toString();
    }
    print('Decrypted Data: ', 'yellow');
    print(`${decryptedDataStr}\n`);
    print('--------\n\n');
};

const getServer = (pubKey) => {
    const encrypt = getServerEncrypt(pubKey);
    const decrypt = getServerDecrypt(pubKey);

    const server = net.createServer((c) => {
        // let dataReceivedMap = new Map();

        c.on('end', () => {
            console.log(`Client disconnected, ip: ${c.remoteAddress}`);
        });

        const chunkMap = new Map();
        c.on('data', (d) => {
            print('\n--------\n');
            print(`Received encrypted data from ${c.remoteAddress}\n`, 'green');
            print('Encrypted: ', 'yellow');
            print(`${d.toString('base64')}\n`);

            const head = d.slice(0, 512);
            const parsedHead = JSON.parse(decrypt(head));
            print(`Decrypted Head: `, 'yellow');
            printSys(parsedHead);
            print('--------\n\n');

            const reqID = parsedHead.req_id;
            if(!chunkMap.has(reqID)) {
                chunkMap.set(reqID, new Map());
            }
            const chunks = chunkMap.get(reqID);

            for(let i = 1; i <= parsedHead.blk_num; i++) { 
                let chunkKey = 0;
                if(parsedHead.use_seg) {
                    chunkKey = (parsedHead.cur_seg_no-1) * MAX_BLK_NUM + i;
                } else {
                    chunkKey = i;
                }
                chunks.set(chunkKey, d.slice(512*i, 512*i+512));
            }
            
            if((!parsedHead.use_seg) || (parsedHead.seg_num === parsedHead.cur_seg_no)) {
                processDataServer(parsedHead, chunks, decrypt);
                chunkMap.delete(reqID);
            }

            const dataReply = `Server has received the data with length ${d.length} - ${addColor(Date().toString(), 'green')}`;
            send(c, encrypt, dataReply);
        });

        // Say hi to client!
        const randomBytes = genRandomBytes(64).toString('hex');
        print(`Client connected, from ${c.remoteAddress}\n`);
        print(`Random string: `, 'green');
        print(`${randomBytes}\n`);
         
        const dataBack = `Hello from server! - ${addColor(Date().toString(), 'green')}`;
        send(c, encrypt, dataBack);
        const randomInfo = `Random string generated by server: ${randomBytes}`;
        send(c, encrypt, randomInfo, head={type: 'random-bytes'});
    });
    return server;
};

module.exports = {
    getServer
};